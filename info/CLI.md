# Интерфейс коммандной строки

### Содержание
- [Быстрый старт](#быстрый-старт)
- [CLI Декодера](#cli-декодера)
  - [Режимы работы](#режимы-работы)
  - [Параметры](#параметры)
  - [Декодирование](#декодирование)
  - [Декодирвоание с обнулением коэффициентов ДКП](#декодирвоание-с-обнулением-коэффициентов-дкп)
  - [Транскодирование](#транскодирование)
  - [Трансдекодирование](#трансдекодирование)
- [CLI нейросети](#cli-нейросети)
  - [Запуск обучения](#запуск-обучения)
  - [Запуск внутреннего предсказания](#запуск-внутреннего-предсказания)
- [CLI скрипта для обработки изображений](#cli-скрипта-для-обработки-изображений)
  - [Параметры](#параметры-1)
  - [Транскодирование](#транскодирование-1)
  - [Трансдекодирование](#трансдекодирование-1)
  - [Замена кода Хаффмана на арифметический кодер](#замена-кода-хаффмана-на-арифметический-кодер)
  - [Рассчет статистики сжатия изображений](#рассчет-статистики-сжатия-изображений)
  - [Запуск функциональных тестов](#запуск-функциональных-тестов)

## Быстрый старт

Для транскодирования изображения требуется выполнить следующую последовательность команд:
```sh
$ ./build/Decoder --zero-out-and-decode -i "original.jpeg" -o "zeroed.ppm" -p 16
$ python3 py/main.py -e -i "zeroed.ppm" -o "enhanced.ppm" --checkpoints_folder "py/checkpoints"
$ ../build/Decoder --encode-residuals -i "original.jpeg" -output "compressed.jpeg" -e "enhanced.ppm" -p 16
$ rm "enhanced.ppm"
```

Для трансдекодирования полученного compressed.jpeg:
```sh
$ ./build/Decoder --zero-out-and-decode -i "compressed.jpeg" -o "zeroed.ppm" -p 16
$ python3 py/main.py -e -i "zeroed.ppm" -o "enhanced.ppm" --checkpoints_folder "py/checkpoints"
$ ../build/Decoder --decode-residuals -i "compressed.jpeg" -o "original.jpeg" -e "enhanced.ppm" -p 16
$ rm "enhanced.ppm"
```

## CLI Декодера

### Режимы работы

Декодер поддерживает 4 режима работы. По-умолчанию происходит стандартное декодирование JPEG. Также можно передать одну из трех опций:
1. `--zero-out-and-decode` — режим, при котором в процессе декодирования дополнительно обнуляются коэффициенты ДКП;
2. `--encode-residuals` — режим транскодирования;
3. `--decode-residuals` — режим трансдекодирования.

### Параметры

Во всех режимах работы кроме режима по умолчанию требуется передать параметр `--power` — число удаляемых коэффициентов. Для транскодирования и трансдекодирования дополнительно требуется опция `--enhanced`, в которой передается путь к изображению, восстановленному нейросетью.

### Декодирование

Пример вызова декодера для декодирования JPEG:
```sh
$ ./Decoder --input "input.jpeg" --output "output.ppm"
```

### Декодирвоание с обнулением коэффициентов ДКП

Пример вызова декодера для декодирования JPEG с частичным обнулением коэффициентов ДКП:
```sh
$ ./Decoder --zero-out-and-decode --input "input.jpeg" --output "output.ppm" --power 16
```

### Транскодирование

Пример вызова декодера для транскодирования:
```sh
$ ./Decoder --encode-residuals --input "original.jpeg" --output "compressed.jpeg" --enhanced "enhanced.ppm" --power 16
```

### Трансдекодирование

Пример вызова декодера для трансдекодирования:
```sh
$ ./Decoder --decode-residuals --input "compressed.jpeg" --output "original.jpeg" --enhanced "enhanced.ppm" --power 16
```

## CLI нейросети

Для удобства работы с моделью был реализован интерфейс командной строки. В нем поддерживаются две опции:
1. `--train` — запуск обучения нейронной сети;
2. `--enhance` — обработка изображений для их транскодирования.

### Запуск обучения

Для запуска обучения модели требуется настройка следующих параметров:
1. `--limit` — ограничение на размер набора данных;
2. `--learning_rate` — скорость обучения;
3. `--checkpoints_folder` — путь к папке, содержащей чекпоинты, то есть файлы, со словарями состояний параметров модели и оптимизатора.

Пример запуска обучения:
```sh
$ python3 py/main.py --train --limit 3600 --learning_rate=0.0001 --checkpoints_folder "py/checkpoints"
```

### Запуск внутреннего предсказания

Для запуска внутреннего предсказания модели необходимо настроить:
1. `--input_wildcard`/`-I` — шаблон файлов, которые требуется обработать;
2. `--output_folder`/`-O` — папка, в которую необходимо сохранить обработанные изображения;
3. `--checkpoints_folder` — путь к папке, содержащей чекпоинты.

Пример запуска внутреннего предсказания:
```sh
$ python3 py/main.py --enhance -I "images/decompressed/tst*.ppm" -O "images/enhanced" --checkpoints_folder "py/checkpoints"
```

## CLI скрипта для обработки изображений

Для выполнения функционального тестирования реализованного транскодера, оценки степени сжатия изображений и анализа возможности интеграции предлагаемого модуля внутреннего предсказания с утилитами Jpegtran и LLJPEG был разработан CLI скрипта [process_images.py](../py/process_images.py). В него были добавлены функции транскодирования и трансдекодирования набора изображений, применения Jpegtran к JPEG-изображениям с целью замены кода Хаффмана на арифметический кодер, функции расчета статистики изображений: средней, медианной и максимальной степеней сжатия, а также опция для запуска end-to-end тестов транскодера.

### Параметры

1. `--input_folder`/`-i` — содержащая входные файлы;
2. `--output_folder`/`-o` — директория, в которую будет записан результат;
3. `--enhanced_folder`/`-e` — директория, содержащая файлы, обработанные нейросетью;
4. `--power`/`-p` — число обнуляемых коэффициентов.

### Транскодирование

Пример транскодирования набора изображений:
```sh
$ python3 py/process_images.py --encode_residuals -i "input_images" -o "output_folder" -e "enhanced_images" --power 16
```

### Трансдекодирование

Пример трансдекодирования набора изображений:
```sh
$ python3 py/process_images.py --decode_residuals -i "input_images" -o "output_folder" -e "enhanced_images" --power 16
```

### Замена кода Хаффмана на арифметический кодер

Пример транскодирования набора изображений, основанного на замене кода Хаффмана на арифметический кодер:
```sh
$ python3 py/process_images.py --arithmetic -i "input_images" -o "output_folder"
```

### Рассчет статистики сжатия изображений

Пример рассчета статистики сжатия изображений:
```sh
$ python3 py/process_images.py --statistics -i "input_images" -o "transcoded_images"
```
### Запуск функциональных тестов

Пример запуска end-to-end тестов транскодера:
```sh
$ python3 py/process_images.py --test_transcoder -i "input_images" -o "transcoded_images"
Test result: succeeded
```
